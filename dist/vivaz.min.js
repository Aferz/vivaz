/*!
 * Vivaz.js v0.1.0
 * (c) 2016 Alejandro Fernandez
 * Released under the MIT License.
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.Vivaz=e()}(this,function(){"use strict";function t(t,e,r,i){this.name=i?"whereNot":"where",this.not=i||!1,this.field=t,this.operator=e,this.value=r,this.resolveArguments()}function e(t,e,r){this.name=r?"whereNotIn":"whereIn",this.not=r||!1,this.field=t,this.value=e,this.resolveArguments()}function r(t,e,r,i){this.name=i?"whereNotDate":"whereDate",this.not=i||!1,this.field=t,this.operator=e,this.value=r,this.resolveArguments().resolveValue()}function i(t,e,r){this.name=r?"whereNotLike":"whereLike",this.not=r||!1,this.field=t,this.expression=e,this.resolveArguments()}function n(t,e,r,i){this.name=i?"whereNotCount":"whereCount",this.not=i||!1,this.field=t,this.operator=e,this.value=r,this.resolveArguments(arguments)}function s(t,e,r,i){this.name=i?"whereNotBetween":"whereBetween",this.not=i||!1,this.field=t,this.min=e,this.max=r,this.resolveArguments()}function o(t,e){this.name="orderBy",this.field=t,this.direction=e||"asc",this.resolveArguments()}function a(t,e){this.name="orderByDate",this.field=t,this.direction=e||"asc",this.resolveArguments()}function h(t,e){this.totalRecords=t.length,this.recordsPerPage=e,p.call(this,t,e)}function u(t){t?this.$data=Array.isArray(t)?t:[t]:this.$data=[]}function l(t){if(!t||"object"==typeof t&&0===Object.keys(t).length)throw"No data supplied!";this.$original=Array.isArray(t)?t:[t],this.clean()}function c(t){return new l(t)}var d=Object.create({},{validOperators:{value:["=","===","!=","!==","<","<=",">=",">","<>"],writable:!1}});t.prototype={field:void 0,operator:void 0,value:void 0,not:!1,resolveArguments:function(t){if(!this.field)throw'No field provided for "'+this.name+'" clause.';(null===this.operator||void 0===this.operator||this.operator===!1||this.operator===!0)&&f.call(this,this.operator);var e=d.validOperators.indexOf(this.operator)>-1;if(e)"==="===this.operator||"!=="===this.operator||null!==this.value&&void 0!==this.value&&this.value!==!1&&this.value!==!0||f.call(this,this.value);else{if(e||void 0!==this.value)throw'Unrecognized "'+this.operator+'" operator for "'+this.name+'" clause.';this.value=this.operator,this.operator="="}return this},resolve:function(t){var e=void 0;switch(this.operator){case"===":e=t===this.value;break;case"=":e=t==this.value;break;case"!==":e=t!==this.value;break;case"!=":case"<>":e=t!=this.value;break;case"<=":e=t<=this.value;break;case"<":e=t<this.value;break;case">=":e=t>=this.value;break;case">":e=t>this.value}return this.not?!e:e}};var f=function(t){var e=null===t?"whereNull()":void 0===t?"whereUndefined()":t===!0?"whereTrue()":"whereFalse()";throw'No correct value provided for "'+this.name+'" clause. For better assertion use '+e+" instead."};e.prototype={field:void 0,value:void 0,not:!1,resolveArguments:function(){if(!this.field)throw'No field provided for "'+this.name+'" clause.';if(!this.value)throw'No value provided for "'+this.name+'" clause.';Array.isArray(this.value)||(this.value=[this.value])},resolve:function(t){var e=this.value.indexOf(t)>-1;return this.not?!e:e}},r.prototype=Object.create(t.prototype),r.prototype.constructor=r,r.prototype.resolveValue=function(){var t=new Date(this.value);if("Invalid Date"==t||null===this.value||void 0===this.value)throw'Value "'+this.value+'" is not a valid date.';return this.value=t,this},r.prototype.resolve=function(t){var e=new Date(t);if("Invalid Date"==e)throw'Invalid date "'+t+'" in field "'+this.field+'".';switch(this.operator){case"=":var r=e.toString()==this.value.toString();break;case"!=":case"<>":var r=e.toString()!=this.value.toString();break;case"<=":var r=e<=this.value;break;case"<":var r=e<this.value;break;case">=":var r=e>=this.value;break;case">":var r=e>this.value}return this.not?!r:r},i.prototype={field:void 0,expression:void 0,not:!1,resolveArguments:function(){if(!this.field)throw'No field provided for "'+this.name+'" clause.';if(!this.expression)throw'No expression provided for "'+this.name+'" clause.'},resolve:function(t){var e=t.match(this.expression)?!0:!1;return this.not?!e:e}},n.prototype=Object.create(t.prototype),n.prototype.constructor=n,n.prototype.resolve=function(t){if(Array.isArray(t))var e=t.length;else var e=t?1:0;switch(this.operator){case"=":var r=e==this.value;break;case"!=":case"<>":var r=e!=this.value;break;case"<=":var r=e<=this.value;break;case"<":var r=e<this.value;break;case">=":var r=e>=this.value;break;case">":var r=e>this.value}return this.not?!r:r},s.prototype={field:void 0,min:void 0,max:void 0,not:!1,resolveArguments:function(){if(!this.field)throw'No field provided for "'+this.name+'" clause.';if(!this.min)throw'No min value provided for "'+this.name+'" clause.';if(!this.max)throw'No max value provided for "'+this.name+'" clause.';if(isNaN(this.min))throw'Min value in "'+this.name+'" is not a number.';if(isNaN(this.max))throw'Max value in "'+this.name+'" is not a number.';if(this.min>this.max)throw"Min value has to be lower than max value."},resolve:function(t){var e=t>=this.min&&t<=this.max;return this.not?!e:e}},o.prototype={field:void 0,direction:void 0,resolveArguments:function(){if(!this.field)throw'No field provided for "'+this.name+'".';if(["asc","desc"].indexOf(this.direction)<0)throw'Unrecognized sort direction "'+this.direction+'".'},resolve:function(t,e){var r=t[this.field]<e[this.field]?-1:t[this.field]>e[this.field]?1:0;return"asc"==this.direction?r:-r}},a.prototype=Object.create(o.prototype),a.prototype.constructor=a,a.prototype.resolve=function(t,e){var r=new Date(t[this.field]),i=new Date(e[this.field]);if("Invalid Date"==r)throw'Invalid date "'+t[this.field]+'" in field "'+this.field+'".';if("Invalid Date"==i)throw'Invalid date "'+e[this.field]+'" in field "'+this.field+'".';var n=i>r?-1:r>i?1:0;return"asc"==this.direction?n:-n};var v=Object.create({createGroupsRecursively:function(t,e,r,i){2==arguments.length&&(r=0,i={});var n=this.selectNestedObject(e,t[r]);if("object"==typeof n)throw"You can't group by an object or array.";return void 0===t[r+1]?(i.hasOwnProperty(n)||(i[n]=[]),i[n].push(e)):i.hasOwnProperty(n)?i[n]=this.createGroupsRecursively(t,e,++r,i[n]):i[n]=this.createGroupsRecursively(t,e,++r,{}),i},createNestedObject:function(t,e,r){if(Array.isArray(e)||(e=this.splitNestedField(e)),1===e.length)t[e[0]]=r;else{var i=e.shift();t[i]=this.createNestedObject("undefined"==typeof t[i]?{}:t[i],e,r)}return t},selectNestedObject:function(t,e,r,i){if(Array.isArray(e)||(e=this.splitNestedField(e)),1===e.length)return i?void(t[e[0]]=i):t[e[0]];var n=e.shift();if(!t[n])throw'Child "'+n+'" not found in "'+r+'".';if(t[n]&&"object"==typeof t[n])return this.selectNestedObject(t[n],e,n,i);throw'Child "'+e.shift()+'" not found in "'+n+"\" child, because it's not an object."},setNestedObjectValue:function(t,e,r){return this.selectNestedObject(t,e,void 0,r),t},splitNestedField:function(t){return t.indexOf(".")>-1?t.split("."):[t]},createModelInstance:function(t,e){var r=[""].concat(Array.isArray(e)?e:[e]);return new(Function.prototype.bind.apply(t,r))}});h.prototype={totalRecords:void 0,recordsPerPage:void 0,totalPages:void 0,pages:[],currentIndex:1,page:function(t){return t>this.totalPages?t=this.totalPages:1>t&&(t=1),this.currentIndex=t||1,this.pages[this.currentIndex-1]},current:function(){return this.pages[this.currentIndex-1]},next:function(){return this.page(this.currentIndex+1)},previous:function(){return this.page(this.currentIndex-1)}};var p=function(t,e){e=e>0?e:1;for(var r=[],i=0;i<t.length;i+=e)r.push(t.slice(i,i+e));return this.pages=r,this.totalPages=this.pages.length,this};u.prototype={all:function(){return this.$data},avg:function(t){return this.sum(t)/this.$data.length},contains:function(t,e,r){if("object"==typeof e)for(var i=0;i<this.$data.length;i++){var n=v.selectNestedObject(this.$data[i],t);if(JSON.stringify(n)===JSON.stringify(e))return!0}else for(var i=0;i<this.$data.length;i++){var n=v.selectNestedObject(this.$data[i],t);if(r===!0&&n===e)return!0;if(!r&&n==e)return!0}return!1},count:function(){return this.$data.length},each:function(t){if("function"!=typeof t)throw"Callback is not a function.";for(var e=0;e<this.$data.length&&t(this.$data[e],e)!==!1;e++);},first:function(){return 0===this.$data.length?{}:this.$data[0]},last:function(){return 0===this.$data.length?{}:this.$data[this.$data.length-1]},max:function(t){if(!t||"object"==typeof t)throw"Invalid field supplied.";for(var e=null,r=0;r<this.$data.length;r++){var i=v.selectNestedObject(this.$data[r],t);if(isNaN(i))throw'"'+t+'" is not a number.';e=!e||i>e?i:e}return e},maxDate:function(t){if(!t||"object"==typeof t)throw"Invalid field supplied.";for(var e=null,r=0;r<this.$data.length;r++){var i=new Date(v.selectNestedObject(this.$data[r],t));if("Invalid Date"==i)throw'"'+t+'" is not a valid date.';e=!e||i>e?i:e}return e},min:function(t){if(!t||"object"==typeof t)throw"Invalid field supplied.";for(var e=null,r=0;r<this.$data.length;r++){var i=v.selectNestedObject(this.$data[r],t);if(isNaN(i))throw'"'+t+'" is not a number.';e=!e||e>i?i:e}return e},minDate:function(t){if(!t||"object"==typeof t)throw"Invalid field supplied.";for(var e=null,r=0;r<this.$data.length;r++){var i=new Date(v.selectNestedObject(this.$data[r],t));if("Invalid Date"==i)throw'"'+t+'" is not a valid date.';e=!e||e>i?i:e}return e},pluck:function(t){for(var e=[],r=0;r<this.$data.length;r++){var i=v.selectNestedObject(this.$data[r],t);void 0!==i&&e.push(i)}return e},pop:function(){return this.$data.pop()},random:function(){return this.$data[Math.floor(Math.random()*this.$data.length)]},search:function(t,e,r){for(var i=[],n=0;n<this.$data.length;n++){var s=v.selectNestedObject(this.$data[n],t);r===!0&&e===s?i.push(n):r||e!=s||i.push(n)}return i},shift:function(){return this.$data.shift()},sort:function(t,e){return this.$data.sort(function(r,i){var n=v.selectNestedObject(r,t)>v.selectNestedObject(i,t)?1:v.selectNestedObject(r,t)<v.selectNestedObject(i,t)?-1:0;return e?-n:n}),this},sortDesc:function(t){return this.sort(t,!0)},splice:function(t){if(0==this.$data.length)return this;var e=[];if(Array.isArray(t)){t.sort(function(t,e){return t>e});for(var r=t.length-1;r>=0;r--)t[r]>=this.$data.length||(e.unshift(this.$data[t[r]]),this.$data.splice(t[r],1))}else t<this.$data.length&&(e.push(this.$data[t]),this.$data.splice(t,1));return e},spliceByValue:function(t,e,r){return this.splice(this.search(t,e,r))},sum:function(t){if(0==this.$data.length)return 0;for(var e=0,r=0;r<this.$data.length;r++){var i=v.selectNestedObject(this.$data[r],t);if(isNaN(i))throw i+" is not a number.";e+=i}return e},toJson:function(){return JSON.stringify(this.$data)},update:function(t,e,r){if(0==this.$data.length)return this;if(Array.isArray(t))for(var i=0;i<t.length;i++)t[i]>=this.$data.length||v.setNestedObjectValue(this.$data[t[i]],e,r);else t<this.$data.length&&v.setNestedObjectValue(this.$data[t],e,r);return this},updateByField:function(t,e,r){return this.update(this.search(t,e),t,r)}};var w=Object.create({resolve:function(){return g.call(this),y.call(this),$.call(this),N.call(this)}}),g=function(){return this.$where.and.length+this.$where.or.length>0&&(this.$result=this.$result.filter(function(t){for(var e=!1,r=0;r<this.$where.and.length;r++){var i=this.$where.and[r],n=v.selectNestedObject(t,i.field);if(e=i.resolve(n),!e){e=!1;break}}if(!e)for(var r=0;r<this.$where.or.length;r++){var i=this.$where.or[r],n=v.selectNestedObject(t,i.field);if(e=i.resolve(n)){e=!0;break}}return e}.bind(this))),this},y=function(){return this.$orderBy.length>0&&this.$result.sort(function(t,e){for(var r=0;r<this.$orderBy.length;r++){var i=this.$orderBy[r].resolve(t,e);if(0!==i)return i}}.bind(this)),this},$=function(){if(this.$groupBy.length>0){var t={};this.$result.map(function(e){t=v.createGroupsRecursively(this.$groupBy,e,0,t)}.bind(this)),this.$result=t}return this},N=function(){if("*"==this.$select)return this;var t=[];return this.$groupBy.length>0&&(this.$result=[this.$result]),this.$result.map(function(e){var r={};for(var i in this.$select)v.createNestedObject(r,this.$select[i],v.selectNestedObject(e,this.$select[i]));t.push(r)}.bind(this)),this.$result=this.$groupBy.length?t[0]:t,this},b=function(t,e){if("and"===e||void 0===e||null===e)this.$where.and.push(t);else{if("or"!==e)throw"Unrecognized boolean value '"+e+"'";this.$where.or.push(t)}return this};return l.prototype={clean:function(){return this.$result=this.$original,this.$select="*",this.$where={and:[],or:[]},this.$groupBy=[],this.$orderBy=[],this},select:function(t){return t?(arguments.length>1?t=Array.prototype.slice.call(arguments):Array.isArray(t)||(t=[t]),this.$select=t,this):this},groupBy:function(t){return t?(arguments.length>1?t=Array.prototype.slice.call(arguments):Array.isArray(t)||(t=[t]),this.$groupBy=t,this):this},where:function(e,r,i,n,s){var o=new t(e,r,i,s);return b.call(this,o,n)},whereNot:function(t,e,r){return this.where(t,e,r,"and",!0)},orWhere:function(t,e,r){return this.where(t,e,r,"or",!1)},orWhereNot:function(t,e,r){return this.where(t,e,r,"or",!0)},whereDate:function(t,e,i,n,s){var o=new r(t,e,i,s);return b.call(this,o,n)},whereNotDate:function(t,e,r){return this.whereDate(t,e,r,"and",!0)},orWhereDate:function(t,e,r){return this.whereDate(t,e,r,"or",!1)},orWhereNotDate:function(t,e,r){return this.whereDate(t,e,r,"or",!0)},whereIn:function(t,r,i,n){var s=new e(t,r,n);return b.call(this,s,i)},whereNotIn:function(t,e){return this.whereIn(t,e,"and",!0)},orWhereIn:function(t,e){return this.whereIn(t,e,"or",!1)},orWhereNotIn:function(t,e){return this.whereIn(t,e,"or",!0)},whereBetween:function(t,e,r,i,n){var o=new s(t,e,r,n);return b.call(this,o,i)},whereNotBetween:function(t,e,r){return this.whereBetween(t,e,r,"and",!0)},orWhereBetween:function(t,e,r){return this.whereBetween(t,e,r,"or",!1)},orWhereNotBetween:function(t,e,r){return this.whereBetween(t,e,r,"or",!0)},whereCount:function(t,e,r,i,s){var o=new n(t,e,r,s);return b.call(this,o,i)},whereNotCount:function(t,e,r){return this.whereCount(t,e,r,"and",!0)},orWhereCount:function(t,e,r){return this.whereCount(t,e,r,"or",!1)},orWhereNotCount:function(t,e,r){return this.whereCount(t,e,r,"or",!0)},whereLike:function(t,e,r,n){var s=new i(t,e,n);return b.call(this,s,r)},whereNotLike:function(t,e){return this.whereLike(t,e,"and",!0)},orWhereLike:function(t,e){return this.whereLike(t,e,"or",!1)},orWhereNotLike:function(t,e){return this.whereLike(t,e,"or",!0)},whereNull:function(e,r,i){var n=new t(e,"===",null,i);return b.call(this,n,r)},whereNotNull:function(t){return this.whereNull(t,"and",!0)},orWhereNull:function(t){return this.whereNull(t,"or",!1)},orWhereNotNull:function(t){return this.whereNull(t,"or",!0)},whereUndefined:function(e,r,i){var n=new t(e,"===",void 0,i);return b.call(this,n,r)},whereNotUndefined:function(t){return this.whereUndefined(t,"and",!0)},orWhereUndefined:function(t){return this.whereUndefined(t,"or",!1)},orWhereNotUndefined:function(t){return this.whereUndefined(t,"or",!0)},whereTrue:function(e,r,i){var n=new t(e,"===",!0,i);return b.call(this,n,r)},whereNotTrue:function(t){return this.whereTrue(t,"and",!0)},orWhereTrue:function(t){return this.whereTrue(t,"or",!1)},orWhereNotTrue:function(t){return this.whereTrue(t,"or",!0)},whereFalse:function(e,r,i){var n=new t(e,"===",!1,i);return b.call(this,n,r)},whereNotFalse:function(t){return this.whereFalse(t,"and",!0)},orWhereFalse:function(t){return this.whereFalse(t,"or",!1)},orWhereNotFalse:function(t){return this.whereFalse(t,"or",!0)},orderBy:function(t,e){return this.$orderBy.push(new o(t,e)),this},orderByDesc:function(t){return this.orderBy(t,"desc")},orderByDate:function(t,e){return this.$orderBy.push(new a(t,e)),this},orderByDateDesc:function(t){return this.orderByDate(t,"desc")},get:function(){return this.$result=this.$original,w.resolve.call(this).$result},first:function(){return this.$groupBy.length>0?this.get():this.get()[0]||[]},last:function(){return this.$groupBy.length>0?this.get():this.get()[this.$result.length-1]||[]},count:function(){return this.$groupBy.length>0?1:this.get().length},paginate:function(t){if(this.$groupBy.length>0)throw"You can't paginate a grouped result.";return new h(this.get(),t||5)},collect:function(){if(this.$groupBy.length>0)throw"Can't make a collection from grouped result.";return new u(this.get())},toModel:function(t,e,r){if(!t)throw"Constructor not supplied.";if("function"!=typeof t)throw"Invalid constructor. It has to be a function.";if(0==this.get().length)return[];for(var i=r||!1,n=Object.keys(this.$result[0]),s=v.createModelInstance(t,e||[]),o=0;o<n.length;o++)if(!i&&s.hasOwnProperty(n[o]))throw'Property "'+n[o]+"\" is already defined in constructor and can't be overrided.";for(var a=[],o=0;o<this.$result.length;o++){var h=v.createModelInstance(t,e||[]);for(var u in this.$result[o])Object.defineProperty(h,u,{value:this.$result[o][u],enumerable:!0});a.push(h)}return a}},c._version="0.1.0",c});